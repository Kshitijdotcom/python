<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoJS: Modern Image Editor</title>
    <!-- Load Inter font for a clean, modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* Define a cleaner, modern color palette and font */
        :root {
            /* Palette */
            --color-bg-primary: #121212; /* Very Dark Gray */
            --color-bg-secondary: #1e1e1e; /* Lighter Dark Gray for panels */
            --color-accent: #00bcd4; /* Cyan/Teal Accent */
            --color-text-light: #f0f0f0;
            --color-text-dim: #999;
            --color-shadow: rgba(0, 0, 0, 0.6);

            /* Image Variables */ 
            --image-opacity: 1;
            --image-brightness: 100%;
            --image-contrast: 100%;
            --image-grayscale: 0%;
            --image-sepia: 0%;
            --image-saturate: 100%;
            --image-hue-rotate: 0deg;
            --image-invert: 0%;
            --image-blur: 0px;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg-primary);
            color: var(--color-text-light);
            display: flex;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- LAYOUT CONTAINER --- */
        .editor-layout {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* --- SIDEBAR CONTROLS --- */
        .sidebar {
            width: 300px;
            background-color: var(--color-bg-secondary);
            overflow-y: auto;
            border-right: 1px solid #333;
            box-shadow: 2px 0 10px var(--color-shadow);
            flex-shrink: 0;
            padding-bottom: 20px;
        }

        .header {
            padding: 20px;
            background-color: #121212;
            border-bottom: 2px solid var(--color-accent);
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Accordion Section Styles */
        .control-section {
            border-bottom: 1px solid #333;
        }

        .section-header {
            padding: 15px 20px;
            cursor: pointer;
            background-color: #252525;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
        }

        .section-header:hover {
            background-color: #333;
            color: var(--color-accent);
        }

        .section-header.active {
            background-color: var(--color-accent);
            color: var(--color-bg-primary);
        }
        
        .section-header.active .arrow {
            transform: rotate(180deg);
        }

        .arrow {
            font-size: 1rem;
            transition: transform 0.3s;
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding: 0 20px;
        }

        .section-content.open {
            /* Set a sufficient height that covers all content */
            max-height: 1000px; 
            padding: 15px 20px;
        }

        /* SLIDER GROUP STYLES */
        .control-group {
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px dashed #333;
        }
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.9rem;
            color: var(--color-text-dim);
            margin-bottom: 5px;
            font-weight: 400;
        }
        
        .slider-wrapper {
            display: flex;
            align-items: center;
        }

        input[type="range"] {
            appearance: none;
            width: 100%;
            height: 8px;
            background: #444;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--color-accent);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 0 5px var(--color-accent);
            transition: background 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #00e5ff;
        }

        .value-display {
            min-width: 40px;
            text-align: right;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-light);
        }

        /* Button Groups */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .style-button {
            background: #333;
            color: var(--color-text-light);
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            font-size: 0.85rem;
            flex-grow: 1;
            min-width: 80px;
            text-align: center;
        }

        .style-button:hover {
            background: #444;
        }

        .style-button.active {
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border-color: var(--color-accent);
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.6);
        }
        
        /* Input file button styling */
        .upload-wrapper {
            padding: 20px;
            border-bottom: 1px solid #333;
            text-align: center;
        }
        .upload-label {
            display: inline-block;
            background-color: var(--color-accent);
            color: var(--color-bg-primary);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .upload-label:hover {
            background-color: #00e5ff;
        }
        .upload-label:active {
            transform: scale(0.98);
        }
        #image-upload {
            display: none;
        }
        
        /* Reset Button */
        #reset-button {
            width: 100%;
            padding: 10px;
            background-color: #e53935;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.2s;
        }

        #reset-button:hover {
            background-color: #f44336;
        }

        /* --- IMAGE EDITOR AREA --- */
        .editor-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: auto; /* Allow scrolling if image is huge */
        }

        #image-container {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            width: 900px; /* Base size for editor frame */
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--color-shadow);
            overflow: hidden;
            transition: opacity 0.3s;
        }

        #editor-image, #original-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            user-select: none;
            transition: filter 0.1s;
        }
        
        #editor-image {
            /* This is the visible image element */
            width: 100%;
            height: 100%;
            filter: 
                brightness(var(--image-brightness)) 
                contrast(var(--image-contrast)) 
                grayscale(var(--image-grayscale)) 
                sepia(var(--image-sepia)) 
                saturate(var(--image-saturate)) 
                hue-rotate(var(--image-hue-rotate)) 
                invert(var(--image-invert))
                blur(var(--image-blur));
            opacity: var(--image-opacity);
        }

        #original-image {
            /* This is a hidden reference image for download canvas */
            display: none;
        }
        
        /* Spinner animation for loading */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .editor-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 50vh;
                border-right: none;
                border-bottom: 1px solid #333;
            }
            .editor-area {
                height: 50vh;
                padding: 10px;
            }
            #image-container {
                width: 100%;
                height: 100%;
                min-height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="editor-layout">
        <!-- Sidebar Controls -->
        <div class="sidebar">
            <div class="header">PhotoJS Editor</div>
            
            <div class="upload-wrapper">
                <input type="file" id="image-upload" accept="image/*">
                <label for="image-upload" class="upload-label">
                    Upload Image
                </label>
                <div style="margin-top: 10px; color: var(--color-text-dim); font-size: 0.85rem;">
                    (Or press Ctrl+V to paste image)
                </div>
                <button id="reset-button">Reset All Adjustments</button>
            </div>

            <!-- Basic Adjustments -->
            <div class="control-section" data-section-id="basic-adjustments">
                <div class="section-header">Basic Adjustments <span class="arrow">▼</span></div>
                <div class="section-content">
                    
                    <div class="control-group">
                        <button id="auto-adjust-button" class="upload-label" style="width: 100%; margin-bottom: 15px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-hover)); font-weight: 600;">
                            Auto Adjust
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <label for="brightness">Brightness</label>
                        <div class="slider-wrapper">
                            <input type="range" id="brightness" min="0" max="200" value="100" data-unit="%" data-css-var="--image-brightness">
                            <span class="value-display">100%</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="contrast">Contrast</label>
                        <div class="slider-wrapper">
                            <input type="range" id="contrast" min="0" max="200" value="100" data-unit="%" data-css-var="--image-contrast">
                            <span class="value-display">100%</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="saturation">Saturation</label>
                        <div class="slider-wrapper">
                            <input type="range" id="saturation" min="0" max="200" value="100" data-unit="%" data-css-var="--image-saturate">
                            <span class="value-display">100%</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="hue-rotate">Hue Rotate</label>
                        <div class="slider-wrapper">
                            <input type="range" id="hue-rotate" min="0" max="360" value="0" data-unit="deg" data-css-var="--image-hue-rotate">
                            <span class="value-display">0deg</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="opacity">Opacity</label>
                        <div class="slider-wrapper">
                            <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" data-unit="" data-css-var="--image-opacity">
                            <span class="value-display">1</span>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Color Effects -->
            <div class="control-section" data-section-id="color-effects">
                <div class="section-header">Color Effects <span class="arrow">▼</span></div>
                <div class="section-content">
                    
                    <!-- Quick Enhancement Buttons for Sharpening -->
                    <div class="control-group">
                        <label>Quick Enhancements (Sharpening Alternative)</label>
                        <div class="button-group" id="quick-enhance-buttons">
                            <!-- This button mimics sharpening by boosting contrast and saturation -->
                            <button class="style-button" data-enhance="sharpen">Sharpen / Detail</button>
                            <button class="style-button" data-enhance="vibrant">Vibrant Pop</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="grayscale">Grayscale</label>
                        <div class="slider-wrapper">
                            <input type="range" id="grayscale" min="0" max="100" value="0" data-unit="%" data-css-var="--image-grayscale">
                            <span class="value-display">0%</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="sepia">Sepia</label>
                        <div class="slider-wrapper">
                            <input type="range" id="sepia" min="0" max="100" value="0" data-unit="%" data-css-var="--image-sepia">
                            <span class="value-display">0%</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="invert">Invert</label>
                        <div class="slider-wrapper">
                            <input type="range" id="invert" min="0" max="100" value="0" data-unit="%" data-css-var="--image-invert">
                            <span class="value-display">0%</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="blur">Blur (Set to 0px to Deblur)</label>
                        <div class="slider-wrapper">
                            <input type="range" id="blur" min="0" max="10" value="0" data-unit="px" data-css-var="--image-blur">
                            <span class="value-display">0px</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Enhancement -->
            <div class="control-section" data-section-id="ai-enhancement">
                <div class="section-header">AI Enhancement <span class="arrow">▼</span></div>
                <div class="section-content">
                    
                    <div class="control-group">
                        <label>Enhancement Preset</label>
                        <div class="button-group" id="preset-buttons">
                            <button class="style-button active" data-preset="general">General</button>
                            <button class="style-button" data-preset="portrait">Portrait</button>
                            <button class="style-button" data-preset="landscape">Landscape</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Upscale Factor</label>
                        <div class="button-group" id="scale-buttons">
                            <button class="style-button active" data-scale="1">1x (No Scale)</button>
                            <button class="style-button" data-scale="2">2x</button>
                            <button class="style-button" data-scale="4">4x</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="enhancement-strength">Enhancement Strength</label>
                        <div class="slider-wrapper">
                            <input type="range" id="enhancement-strength" min="0" max="100" value="80" data-unit="%">
                            <span class="value-display">80%</span>
                        </div>
                    </div>

                    <div class="control-group" style="border-bottom: none;">
                        <button id="auto-enhance-button" class="upload-label" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-hover)); font-weight: 600;">
                            Auto Enhance
                        </button>
                        <button id="ai-enhance-button" class="upload-label" style="width: 100%; margin-bottom: 10px;">
                            AI Enhance (Manual)
                        </button>
                        <div id="enhancement-status" style="display: none; text-align: center; color: var(--color-accent); font-size: 0.9rem; margin-top: 10px;">
                            <div class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid var(--color-accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span id="status-text" style="margin-left: 8px;">Processing...</span>
                        </div>
                        <div id="enhancement-error" style="display: none; text-align: center; color: #e53935; font-size: 0.85rem; margin-top: 10px; padding: 8px; background: rgba(229, 57, 53, 0.1); border-radius: 4px;">
                        </div>
                    </div>

                    <div class="control-group" id="enhancement-controls" style="display: none; border-bottom: none;">
                        <button id="compare-button" class="style-button" style="width: 100%; margin-bottom: 8px;">
                            Compare Original
                        </button>
                        <button id="undo-enhancement-button" class="style-button" style="width: 100%; background: #e53935; border-color: #e53935;">
                            Undo Enhancement
                        </button>
                    </div>

                </div>
            </div>

            <!-- Download Button -->
            <div style="padding: 20px;">
                <button id="download-button" class="upload-label" style="width: 100%;">Download Edited Image</button>
            </div>
            
        </div>

        <!-- Editor Area -->
        <div class="editor-area">
            <!-- This container holds the image and applies CSS filters -->
            <div id="image-container">
                <img id="editor-image" alt="Image being edited" 
                    src="https://placehold.co/900x600/353535/FFFFFF?text=Upload+Image+or+Paste+(Ctrl+V)">
                <!-- Hidden canvas for rendering image with filters before download -->
                <canvas id="render-canvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let originalStyles = {};
        const mainEditorImage = document.getElementById('editor-image');
        const renderCanvas = document.getElementById('render-canvas');
        const inputs = document.querySelectorAll('input[type="range"]'); 
        const quickEnhanceButtons = document.querySelectorAll('#quick-enhance-buttons .style-button');
        
        // AI Enhancement state
        const enhancementState = {
            isProcessing: false,
            originalImage: null,
            enhancedImage: null,
            currentPreset: 'general',
            currentScale: 1,
            currentStrength: 80,
            compareMode: false
        };
        
        // --- UTILITY FUNCTIONS ---
        
        // Helper function to update slider values and CSS based on preset
        function applyFilterPreset(b, c, s, h, gr, sep, inv, bl) {
            const filters = [
                { id: 'brightness', val: b },
                { id: 'contrast', val: c },
                { id: 'saturation', val: s },
                { id: 'hue-rotate', val: h },
                { id: 'grayscale', val: gr },
                { id: 'sepia', val: sep },
                { id: 'invert', val: inv },
                { id: 'blur', val: bl },
                { id: 'opacity', val: 1 } // Always reset opacity to full for presets
            ];

            filters.forEach(filter => {
                const input = document.getElementById(filter.id);
                if (input) {
                    input.value = filter.val;
                    // Trigger the existing update handler to set the CSS variable and display text
                    handleUpdate({ target: input });
                }
            });
        }

        // Caches the initial values of all editable properties on load
        function cacheInitialStyles() {
            inputs.forEach(input => {
                const cssVar = input.dataset.cssVar;
                const value = input.value;
                const unit = input.dataset.unit || '';
                
                // Opacity needs special handling as it uses a factor of 1, not 0.01 like previous versions
                const numericValue = parseFloat(value);
                
                // Store initial value
                originalStyles[cssVar] = {
                    value: value,
                    unit: unit,
                    defaultCSS: `${numericValue}${unit}`
                };
                
                // Apply initial CSS var
                document.documentElement.style.setProperty(cssVar, originalStyles[cssVar].defaultCSS);
            });
        }

        // --- HANDLERS ---

        // Handles all slider changes
        function handleUpdate(e) {
            const input = e.target;
            const cssVar = input.dataset.cssVar;
            
            let value = parseFloat(input.value);
            const unit = input.dataset.unit || '';
            
            let displayValue = `${value}${unit}`;

            // Update the value display next to the slider
            const displaySpan = input.closest('.slider-wrapper')?.querySelector('.value-display');
            if (displaySpan) {
                // If opacity, just show the number without %
                displaySpan.textContent = (input.id === 'opacity') ? value.toFixed(2) : displayValue;
            }
            
            // Apply the CSS variable
            document.documentElement.style.setProperty(cssVar, displayValue);

            // Remove active state from enhancement buttons if a manual slider is used
            if(input.closest('#quick-enhance-buttons') === null) {
                quickEnhanceButtons.forEach(btn => btn.classList.remove('active'));
            }
        }
        
        // Handles accordion functionality
        function toggleSection(sectionId) {
            const allSections = document.querySelectorAll('.control-section');
            const targetSection = document.querySelector(`[data-section-id="${sectionId}"]`);
            const targetContent = targetSection.querySelector('.section-content');
            const targetHeader = targetSection.querySelector('.section-header');

            allSections.forEach(section => {
                const content = section.querySelector('.section-content');
                const header = section.querySelector('.section-header');
                
                if (section.dataset.sectionId !== sectionId || !header.classList.contains('active')) {
                    // Close other sections
                    content.classList.remove('open');
                    header.classList.remove('active');
                }
            });
            
            // Toggle the target section
            if (targetHeader.classList.contains('active')) {
                // If it was open, close it
                targetContent.classList.remove('open');
                targetHeader.classList.remove('active');
            } else {
                // If it was closed, open it
                targetContent.classList.add('open');
                targetHeader.classList.add('active');
            }
        }

        // Resets all sliders to default
        function resetAdjustments() {
            // Reset sliders
            inputs.forEach(input => {
                const cssVar = input.dataset.cssVar;
                const defaultProps = originalStyles[cssVar];
                
                if (!defaultProps) return;

                // Reset input value
                input.value = defaultProps.value;

                // Update display and CSS var
                const displaySpan = input.closest('.slider-wrapper')?.querySelector('.value-display');
                if (displaySpan) {
                     // Handle opacity display separately
                    displaySpan.textContent = (input.id === 'opacity') ? parseFloat(defaultProps.value).toFixed(2) : defaultProps.defaultCSS;
                }
                
                document.documentElement.style.setProperty(cssVar, defaultProps.defaultCSS);
            });

            // Reset enhancement buttons
            quickEnhanceButtons.forEach(btn => btn.classList.remove('active'));
        }
        
        // Handles file upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageUrl = event.target.result;
                    loadImage(imageUrl);
                };
                reader.readAsDataURL(file);
            }
        }

        // Handles image pasting from clipboard
        function handlePaste(e) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        loadImage(event.target.result);
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault(); // Prevent default paste action
                    break;
                }
            }
        }
        
        // Common function to load image into editor
        function loadImage(imageUrl) {
            // Temporarily dim editor while loading
            document.getElementById('image-container').style.opacity = '0.5'; 
            
            // Reset all adjustments upon new image load
            resetAdjustments();

            mainEditorImage.onload = () => {
                document.getElementById('image-container').style.opacity = '1';
                console.log("Image loaded successfully.");
            };
            
            mainEditorImage.onerror = () => {
                console.error("Error loading image. Check URL or file integrity.");
                document.getElementById('image-container').style.opacity = '1';
                // Fallback to placeholder on error
                mainEditorImage.src = 'https://placehold.co/900x600/FF0000/FFFFFF?text=Image+Load+Failed';
            };
            
            // For cross-origin issues with canvas download, we remove the attribute for local files (like pasted/uploaded).
            // If the URL is external, we would need to check if CORS is enabled, but for local data URLs, it's fine.
            mainEditorImage.removeAttribute('crossOrigin');

            // Set the display image source
            mainEditorImage.src = imageUrl;
        }
        
        // Handles Quick Enhancement button clicks
        function handleQuickEnhance(e) {
            const button = e.target;
            const type = button.dataset.enhance;

            // Remove active state from all buttons in the group
            quickEnhanceButtons.forEach(btn => btn.classList.remove('active'));
            
            // Toggle logic
            if (button.classList.contains('active')) {
                // If it was active, deselect and reset filters
                button.classList.remove('active');
                resetAdjustments(); // Safer to reset all when toggling off
                return;
            }

            // Apply new preset
            button.classList.add('active');

            if (type === 'sharpen') {
                // Sharpen preset: High Contrast and Saturation boost mimics sharpness
                applyFilterPreset(105, 125, 125, 0, 0, 0, 0, 0); // B, C, S, H, Gr, Sep, Inv, Blur
            } else if (type === 'vibrant') {
                // Vibrant preset: Slight boost to Brightness, Saturation, and a touch of Contrast
                applyFilterPreset(110, 105, 150, 0, 0, 0, 0, 0); // B, C, S, H, Gr, Sep, Inv, Blur
            }
        }

        // Handles image download by drawing the filtered image onto a canvas
        function downloadImage() {
            if (!mainEditorImage.src || mainEditorImage.src.includes('placehold.co')) {
                 // Use a custom alert message substitute
                 const container = document.getElementById('image-container');
                 const msg = document.createElement('div');
                 msg.textContent = 'Please upload or paste an image first!';
                 msg.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #e53935; color: white; padding: 15px; border-radius: 8px; z-index: 100; font-weight: bold; animation: fadeout 3s forwards;';
                 
                 // Add a simple CSS animation for the message fade
                 const style = document.createElement('style');
                 style.textContent = '@keyframes fadeout { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }';
                 document.head.appendChild(style);
                 
                 container.appendChild(msg);
                 setTimeout(() => { msg.remove(); }, 3000);
                 return;
            }

            // 1. Set canvas size to the natural image dimensions
            renderCanvas.width = mainEditorImage.naturalWidth;
            renderCanvas.height = mainEditorImage.naturalHeight;
            const ctx = renderCanvas.getContext('2d');
            
            // 2. Clear canvas
            ctx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);
            
            // 3. Apply the current CSS filters to the canvas context
            const currentFilter = getComputedStyle(mainEditorImage).filter;
            const currentOpacity = getComputedStyle(mainEditorImage).opacity;
            
            ctx.filter = currentFilter;
            ctx.globalAlpha = parseFloat(currentOpacity);

            // 4. Draw the original image onto the canvas with filters applied
            ctx.drawImage(mainEditorImage, 0, 0, renderCanvas.width, renderCanvas.height);

            // 5. Create a download link
            const link = document.createElement('a');
            link.download = 'PhotoJS_Edited_Image.png';
            link.href = renderCanvas.toDataURL('image/png');
            link.click();
        }

        // --- AI ENHANCEMENT FUNCTIONS ---
        
        async function enhanceImage(imageData, preset, scale, strength) {
            try {
                const response = await fetch('/enhance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData,
                        preset: preset,
                        scale: scale,
                        strength: strength
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Enhancement failed');
                }
                
                return result;
            } catch (error) {
                console.error('Enhancement API error:', error);
                throw error;
            }
        }
        
        function showEnhancementStatus(message) {
            const statusDiv = document.getElementById('enhancement-status');
            const statusText = document.getElementById('status-text');
            statusText.textContent = message;
            statusDiv.style.display = 'block';
            document.getElementById('enhancement-error').style.display = 'none';
        }
        
        function hideEnhancementStatus() {
            document.getElementById('enhancement-status').style.display = 'none';
        }
        
        function showEnhancementError(message) {
            const errorDiv = document.getElementById('enhancement-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            hideEnhancementStatus();
        }
        
        function hideEnhancementError() {
            document.getElementById('enhancement-error').style.display = 'none';
        }
        
        async function handleAIEnhance() {
            if (enhancementState.isProcessing) return;
            
            // Check if image is loaded
            if (!mainEditorImage.src || mainEditorImage.src.includes('placehold.co')) {
                showEnhancementError('Please upload or paste an image first!');
                return;
            }
            
            enhancementState.isProcessing = true;
            const enhanceButton = document.getElementById('ai-enhance-button');
            enhanceButton.disabled = true;
            enhanceButton.style.opacity = '0.5';
            
            hideEnhancementError();
            showEnhancementStatus('Processing...');
            
            // Store original image if not already stored
            if (!enhancementState.originalImage) {
                enhancementState.originalImage = mainEditorImage.src;
            }
            
            try {
                // Get current image as base64
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = mainEditorImage.naturalWidth;
                canvas.height = mainEditorImage.naturalHeight;
                ctx.drawImage(mainEditorImage, 0, 0);
                const imageData = canvas.toDataURL('image/png');
                
                // Show estimated time after 3 seconds
                const timeoutId = setTimeout(() => {
                    showEnhancementStatus('Processing... This may take 10-30 seconds');
                }, 3000);
                
                // Call enhancement API
                const result = await enhanceImage(
                    imageData,
                    enhancementState.currentPreset,
                    enhancementState.currentScale,
                    enhancementState.currentStrength
                );
                
                clearTimeout(timeoutId);
                
                // Update image with enhanced version
                const enhancedImageData = 'data:image/png;base64,' + result.enhanced_image_base64;
                enhancementState.enhancedImage = enhancedImageData;
                mainEditorImage.src = enhancedImageData;
                
                // Show success message with processing time
                const processingTime = result.metadata.processing_time;
                showEnhancementStatus(`✓ Enhanced in ${processingTime}s`);
                setTimeout(hideEnhancementStatus, 3000);
                
                // Show compare and undo buttons
                document.getElementById('enhancement-controls').style.display = 'block';
                
                console.log('Enhancement metadata:', result.metadata);
                
            } catch (error) {
                showEnhancementError(`Enhancement failed: ${error.message}`);
            } finally {
                enhancementState.isProcessing = false;
                enhanceButton.disabled = false;
                enhanceButton.style.opacity = '1';
            }
        }
        
        function handleCompareToggle() {
            if (!enhancementState.originalImage || !enhancementState.enhancedImage) return;
            
            enhancementState.compareMode = !enhancementState.compareMode;
            const compareButton = document.getElementById('compare-button');
            
            if (enhancementState.compareMode) {
                mainEditorImage.src = enhancementState.originalImage;
                compareButton.textContent = 'Show Enhanced';
                compareButton.classList.add('active');
            } else {
                mainEditorImage.src = enhancementState.enhancedImage;
                compareButton.textContent = 'Compare Original';
                compareButton.classList.remove('active');
            }
        }
        
        function handleUndoEnhancement() {
            if (!enhancementState.originalImage) return;
            
            mainEditorImage.src = enhancementState.originalImage;
            enhancementState.enhancedImage = null;
            enhancementState.originalImage = null;
            enhancementState.compareMode = false;
            
            document.getElementById('enhancement-controls').style.display = 'none';
            hideEnhancementStatus();
            hideEnhancementError();
        }
        
        // Auto Adjust - Automatically adjusts brightness, contrast, saturation based on image analysis
        function handleAutoAdjust() {
            try {
                // Get current image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = mainEditorImage.naturalWidth;
                canvas.height = mainEditorImage.naturalHeight;
                ctx.drawImage(mainEditorImage, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Analyze image statistics
                let totalBrightness = 0;
                let totalSaturation = 0;
                let pixelCount = 0;
                
                // Sample every 10th pixel for performance
                for (let i = 0; i < data.length; i += 40) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Calculate brightness (perceived luminance)
                    const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
                    totalBrightness += brightness;
                    
                    // Calculate saturation
                    const max = Math.max(r, g, b);
                    const min = Math.min(r, g, b);
                    const saturation = max === 0 ? 0 : (max - min) / max;
                    totalSaturation += saturation;
                    
                    pixelCount++;
                }
                
                const avgBrightness = totalBrightness / pixelCount;
                const avgSaturation = totalSaturation / pixelCount;
                
                // Calculate optimal adjustments (range: 0-200, default: 100)
                let brightnessAdjust = 100;
                let contrastAdjust = 100;
                let saturationAdjust = 100;
                
                // Brightness adjustment (target: 128, range: 0-255)
                if (avgBrightness < 100) {
                    brightnessAdjust = 100 + ((100 - avgBrightness) / 100 * 30);
                } else if (avgBrightness > 160) {
                    brightnessAdjust = 100 - ((avgBrightness - 160) / 95 * 20);
                }
                
                // Contrast adjustment
                if (avgBrightness > 80 && avgBrightness < 180) {
                    contrastAdjust = 115;
                } else {
                    contrastAdjust = 105;
                }
                
                // Saturation adjustment
                if (avgSaturation < 0.25) {
                    saturationAdjust = 100 + ((0.25 - avgSaturation) / 0.25 * 30);
                } else if (avgSaturation > 0.6) {
                    saturationAdjust = 100 - ((avgSaturation - 0.6) / 0.4 * 20);
                }
                
                // Clamp values
                brightnessAdjust = Math.max(0, Math.min(200, Math.round(brightnessAdjust)));
                contrastAdjust = Math.max(0, Math.min(200, Math.round(contrastAdjust)));
                saturationAdjust = Math.max(0, Math.min(200, Math.round(saturationAdjust)));
                
                // Apply adjustments to sliders
                const brightnessSlider = document.getElementById('brightness');
                const contrastSlider = document.getElementById('contrast');
                const saturationSlider = document.getElementById('saturation');
                
                brightnessSlider.value = brightnessAdjust;
                contrastSlider.value = contrastAdjust;
                saturationSlider.value = saturationAdjust;
                
                // Trigger update events
                brightnessSlider.dispatchEvent(new Event('input'));
                contrastSlider.dispatchEvent(new Event('input'));
                saturationSlider.dispatchEvent(new Event('input'));
                
                showEnhancementStatus('Auto-adjusted based on image analysis');
                setTimeout(hideEnhancementStatus, 2000);
                
            } catch (error) {
                console.error('Auto adjust error:', error);
                showEnhancementError('Auto adjust failed');
            }
        }
        
        // Auto Enhance - Automatically detects image type and applies best enhancement
        async function handleAutoEnhance() {
            if (enhancementState.isProcessing) return;
            
            const autoEnhanceButton = document.getElementById('auto-enhance-button');
            enhancementState.isProcessing = true;
            autoEnhanceButton.disabled = true;
            autoEnhanceButton.style.opacity = '0.5';
            
            hideEnhancementError();
            showEnhancementStatus('Analyzing image...');
            
            if (!enhancementState.originalImage) {
                enhancementState.originalImage = mainEditorImage.src;
            }
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let width = mainEditorImage.naturalWidth;
                let height = mainEditorImage.naturalHeight;
                
                const maxDimension = 3000;
                if (width > maxDimension || height > maxDimension) {
                    const scale = maxDimension / Math.max(width, height);
                    width = Math.floor(width * scale);
                    height = Math.floor(height * scale);
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(mainEditorImage, 0, 0, width, height);
                
                // Analyze image to detect type
                const imageData = ctx.getImageData(0, 0, width, height);
                const detectedPreset = detectImageType(imageData, width, height);
                
                showEnhancementStatus(`Detected ${detectedPreset} image. Enhancing...`);
                
                const base64Data = canvas.toDataURL('image/jpeg', 0.9);
                
                const timeoutId = setTimeout(() => {
                    showEnhancementStatus('Processing... This may take 10-30 seconds');
                }, 3000);
                
                const result = await enhanceImage(base64Data, detectedPreset, 1, 85);
                
                clearTimeout(timeoutId);
                
                const enhancedImageData = 'data:image/jpeg;base64,' + result.enhanced_image_base64;
                enhancementState.enhancedImage = enhancedImageData;
                mainEditorImage.src = enhancedImageData;
                
                const processingTime = result.metadata.processing_time;
                showEnhancementStatus(`Auto-enhanced (${detectedPreset}) in ${processingTime}s`);
                setTimeout(hideEnhancementStatus, 3000);
                
                document.getElementById('enhancement-controls').style.display = 'block';
                
            } catch (error) {
                showEnhancementError(`Auto enhance failed: ${error.message}`);
            } finally {
                enhancementState.isProcessing = false;
                autoEnhanceButton.disabled = false;
                autoEnhanceButton.style.opacity = '1';
            }
        }
        
        // Detect image type based on content analysis
        function detectImageType(imageData, width, height) {
            const data = imageData.data;
            let skinTonePixels = 0;
            let totalPixels = width * height;
            let greenPixels = 0;
            let bluePixels = 0;
            
            for (let i = 0; i < data.length; i += 40) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Detect skin tones (portraits)
                if (r > 95 && g > 40 && b > 20 && r > g && r > b && Math.abs(r - g) > 15) {
                    skinTonePixels++;
                }
                
                // Detect greenery (landscapes)
                if (g > r && g > b && g > 60) {
                    greenPixels++;
                }
                
                // Detect sky/water (landscapes)
                if (b > r && b > g && b > 80) {
                    bluePixels++;
                }
            }
            
            const sampledPixels = totalPixels / 10;
            const skinToneRatio = skinTonePixels / sampledPixels;
            const greenRatio = greenPixels / sampledPixels;
            const blueRatio = bluePixels / sampledPixels;
            
            if (skinToneRatio > 0.15) {
                return 'portrait';
            } else if (greenRatio > 0.25 || blueRatio > 0.25) {
                return 'landscape';
            } else {
                return 'general';
            }
        }

        // --- EVENT LISTENERS & INITIALIZATION ---

        function init() {
            // Cache styles before any interaction
            cacheInitialStyles();
            
            // Attach listeners to all sliders
            inputs.forEach(input => {
                input.addEventListener('input', handleUpdate);
                input.addEventListener('change', handleUpdate); 
            });

            // Attach listeners for accordion headers
            document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sectionId = header.parentElement.dataset.sectionId;
                    toggleSection(sectionId);
                });
            });
            
            // Attach listener for quick enhancement buttons
            quickEnhanceButtons.forEach(btn => btn.addEventListener('click', handleQuickEnhance));

            // File and Reset listeners
            document.getElementById('image-upload').addEventListener('change', handleImageUpload);
            document.getElementById('download-button').addEventListener('click', downloadImage);
            document.getElementById('reset-button').addEventListener('click', resetAdjustments);
            
            // Paste listener for the entire document
            document.addEventListener('paste', handlePaste);
            
            // AI Enhancement listeners
            const presetButtons = document.querySelectorAll('#preset-buttons .style-button');
            presetButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    presetButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    enhancementState.currentPreset = btn.dataset.preset;
                });
            });
            
            const scaleButtons = document.querySelectorAll('#scale-buttons .style-button');
            scaleButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    scaleButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    enhancementState.currentScale = parseInt(btn.dataset.scale);
                });
            });
            
            const strengthSlider = document.getElementById('enhancement-strength');
            strengthSlider.addEventListener('input', (e) => {
                enhancementState.currentStrength = parseInt(e.target.value);
                e.target.nextElementSibling.textContent = e.target.value + '%';
            });
            
            document.getElementById('auto-adjust-button').addEventListener('click', handleAutoAdjust);
            document.getElementById('auto-enhance-button').addEventListener('click', handleAutoEnhance);
            document.getElementById('ai-enhance-button').addEventListener('click', handleAIEnhance);
            document.getElementById('compare-button').addEventListener('click', handleCompareToggle);
            document.getElementById('undo-enhancement-button').addEventListener('click', handleUndoEnhancement);
            
            // Initial setup to ensure the UI starts with the first section expanded
            toggleSection('basic-adjustments');
        }

        window.onload = init;

    </script>
</body>
</html>


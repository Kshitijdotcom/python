<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoCrest - Professional Photo Editor</title>
    <!-- Load Inter font for a clean, modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* Define a cleaner, modern color palette and font */
        :root {
            /* Premium Color Palette - Professional Dark Theme */
            --color-bg-primary: #0a0a0a; /* Deep Black */
            --color-bg-secondary: #141414; /* Charcoal */
            --color-bg-tertiary: #1c1c1c; /* Dark Gray */
            --color-accent: #c9a961; /* Elegant Gold */
            --color-accent-hover: #d4b76e; /* Warm Gold */
            --color-text-light: #ffffff;
            --color-text-dim: #a0a0a0;
            --color-text-dimmer: #707070;
            --color-border: #2a2a2a;
            --color-shadow: rgba(0, 0, 0, 0.95);

            /* Image Variables */ 
            --image-opacity: 1;
            --image-brightness: 100%;
            --image-contrast: 100%;
            --image-grayscale: 0%;
            --image-sepia: 0%;
            --image-saturate: 100%;
            --image-hue-rotate: 0deg;
            --image-invert: 0%;
            --image-blur: 0px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg-primary);
            color: var(--color-text-light);
            display: flex;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- LAYOUT CONTAINER --- */
        .editor-layout {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* --- SIDEBAR CONTROLS --- */
        .sidebar {
            width: 280px;
            background-color: var(--color-bg-secondary);
            overflow-y: auto;
            border-right: 1px solid var(--color-border);
            box-shadow: 4px 0 24px var(--color-shadow);
            flex-shrink: 0;
            padding-bottom: 20px;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: var(--color-bg-secondary);
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .header {
            padding: 28px 20px;
            background-color: var(--color-bg-primary);
            border-bottom: 1px solid var(--color-border);
            text-align: left;
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--color-text-light);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20px;
            width: 40px;
            height: 2px;
            background: var(--color-accent);
        }
        
        .header a:hover {
            color: var(--color-accent) !important;
        }

        /* Accordion Section Styles */
        .control-section {
            border-bottom: 1px solid var(--color-border);
        }

        .section-header {
            padding: 18px 20px;
            cursor: pointer;
            background-color: var(--color-bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            color: var(--color-text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
        }

        .section-header:hover {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-light);
            padding-left: 24px;
        }

        .section-header.active {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-light);
            border-left: 3px solid var(--color-accent);
            padding-left: 20px;
        }
        
        .section-header.active .arrow {
            transform: rotate(180deg);
        }

        .arrow {
            font-size: 0.7rem;
            transition: transform 0.3s ease;
            opacity: 0.6;
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0 20px;
            background-color: var(--color-bg-secondary);
        }

        .section-content.open {
            /* Set a sufficient height that covers all content */
            max-height: 1200px; 
            padding: 24px 20px;
            background-color: var(--color-bg-tertiary);
        }

        /* SLIDER GROUP STYLES */
        .control-group {
            margin-bottom: 20px;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.8rem;
            color: var(--color-text-dim);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .slider-wrapper {
            display: flex;
            align-items: center;
        }

        input[type="range"] {
            appearance: none;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, #2a2a2a 0%, #2a2a2a 100%);
            border-radius: 2px;
            cursor: pointer;
            margin-right: 12px;
            position: relative;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--color-accent);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.5);
            transition: all 0.2s ease;
            border: 2px solid var(--color-bg-primary);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--color-accent-hover);
            box-shadow: 0 3px 12px rgba(201, 169, 97, 0.7);
            transform: scale(1.1);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--color-accent);
            border-radius: 50%;
            border: 2px solid var(--color-bg-primary);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.5);
            transition: all 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: var(--color-accent-hover);
            box-shadow: 0 3px 12px rgba(201, 169, 97, 0.7);
            transform: scale(1.1);
        }

        input[type="range"]::-moz-range-thumb:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .value-display {
            min-width: 50px;
            text-align: right;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--color-accent);
            font-variant-numeric: tabular-nums;
        }

        /* Button Groups */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .style-button {
            background: var(--color-bg-primary);
            color: var(--color-text-dim);
            border: 1px solid #2a2a2a;
            padding: 11px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.8rem;
            flex-grow: 1;
            min-width: 75px;
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }

        .style-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(201, 169, 97, 0.1), transparent);
            transition: left 0.5s;
        }

        .style-button:hover::before {
            left: 100%;
        }

        .style-button:hover {
            background: #1a1a1a;
            color: var(--color-text-light);
            border-color: #3a3a3a;
            transform: translateY(-1px);
        }

        .style-button.active {
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border-color: var(--color-accent);
            box-shadow: 0 4px 16px rgba(201, 169, 97, 0.4);
            font-weight: 600;
            transform: translateY(0);
        }

        .style-button.active:hover {
            background: var(--color-accent-hover);
            transform: translateY(-1px);
        }
        
        .style-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--color-bg-primary);
            color: var(--color-text-dimmer);
            border-color: #1a1a1a;
            transform: none;
        }
        
        .style-button:disabled:hover {
            background: var(--color-bg-primary);
            color: var(--color-text-dimmer);
            border-color: #1a1a1a;
            transform: none;
        }
        
        .style-button:disabled::before {
            display: none;
        }
        
        /* Input file button styling */
        .upload-wrapper {
            padding: 28px 20px;
            border-bottom: 1px solid var(--color-border);
            text-align: center;
        }
        .upload-label {
            display: inline-block;
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
            color: var(--color-bg-primary);
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(201, 169, 97, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }
        
        .upload-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .upload-label:hover::before {
            left: 100%;
        }
        
        .upload-label:hover {
            box-shadow: 0 6px 24px rgba(201, 169, 97, 0.5);
            transform: translateY(-2px);
        }
        .upload-label:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
        }
        #image-upload {
            display: none;
        }
        
        /* Reset Button */
        #reset-button {
            width: 100%;
            padding: 11px;
            background-color: var(--color-bg-primary);
            color: var(--color-text-dim);
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #reset-button:hover {
            background-color: rgba(214, 69, 69, 0.1);
            color: #ff6b6b;
            border-color: #ff6b6b;
            transform: translateY(-1px);
        }
        
        #reset-button:active {
            transform: translateY(0);
        }

        /* --- IMAGE EDITOR AREA --- */
        .editor-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: auto; /* Allow scrolling if image is huge */
        }

        /* Preview Toggle Controls */
        .preview-controls {
            display: none;
            margin-bottom: 15px;
            padding: 8px 16px;
            background: var(--color-bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .preview-controls.show {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preview-toggle {
            background: var(--color-bg-primary);
            color: var(--color-text-dim);
            border: 1px solid #2a2a2a;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-toggle:hover {
            background: #1a1a1a;
            color: var(--color-text-light);
            border-color: #3a3a3a;
        }

        .preview-toggle.active {
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border-color: var(--color-accent);
        }

        #image-container {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            width: 900px; /* Base size for editor frame */
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #0f0f0f 0%, #0a0a0a 100%);
            border-radius: 12px;
            box-shadow: 0 24px 64px var(--color-shadow), 0 0 0 1px rgba(255, 255, 255, 0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        #image-container:hover {
            box-shadow: 0 28px 72px var(--color-shadow), 0 0 0 1px rgba(201, 169, 97, 0.2);
        }

        /* Before/After Split View Styles */
        .split-view-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: none; /* Hidden by default */
        }

        .split-view-container.active {
            display: block;
        }

        .split-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none;
        }

        .split-image.original {
            z-index: 1;
        }

        .split-image.edited {
            z-index: 2;
            clip-path: polygon(50% 0%, 100% 0%, 100% 100%, 50% 100%);
            transition: clip-path 0.1s ease;
        }

        .split-slider {
            position: absolute;
            top: 0;
            left: 50%;
            width: 3px;
            height: 100%;
            background: var(--color-accent);
            cursor: ew-resize;
            z-index: 3;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(201, 169, 97, 0.5);
        }

        .split-slider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: var(--color-accent);
            border: 2px solid var(--color-bg-primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.5);
        }

        .split-slider::after {
            content: '';
            position: absolute;
            top: 0;
            left: -10px;
            width: 23px;
            height: 100%;
            cursor: ew-resize;
        }

        .split-labels {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 4;
            pointer-events: none;
        }

        .split-label {
            background: rgba(0, 0, 0, 0.7);
            color: var(--color-text-light);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .split-label.original {
            background: rgba(229, 57, 53, 0.8);
        }

        .split-label.edited {
            background: rgba(201, 169, 97, 0.8);
        }

        #editor-image, #original-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            user-select: none;
            transition: filter 0.1s;
        }
        
        #editor-image {
            /* This is the visible image element */
            width: 100%;
            height: 100%;
            filter: 
                brightness(var(--image-brightness)) 
                contrast(var(--image-contrast)) 
                grayscale(var(--image-grayscale)) 
                sepia(var(--image-sepia)) 
                saturate(var(--image-saturate)) 
                hue-rotate(var(--image-hue-rotate)) 
                invert(var(--image-invert))
                blur(var(--image-blur));
            opacity: var(--image-opacity);
        }

        #original-image {
            /* This is a hidden reference image for download canvas */
            display: none;
        }
        
        /* Spinner animation for loading */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-content.open > * {
            animation: fadeIn 0.3s ease-out;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .editor-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 50vh;
                border-right: none;
                border-bottom: 1px solid #2a2a2a;
            }
            .editor-area {
                height: 50vh;
                padding: 10px;
            }
            .preview-controls {
                margin-bottom: 10px;
                padding: 6px 12px;
            }
            .preview-toggle {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            #image-container {
                width: 100%;
                height: 100%;
                min-height: 250px;
            }
            .header {
                font-size: 1.1rem;
                padding: 20px;
            }
            .split-labels {
                bottom: 5px;
                padding: 0 10px;
            }
            .split-label {
                font-size: 0.6rem;
                padding: 2px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="editor-layout">
        <!-- Sidebar Controls -->
        <div class="sidebar">
            <div class="header">
                <span>PHOTOCREST</span>
                <a href="/logout" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--color-text-dim); font-size: 0.75rem; text-decoration: none; font-weight: 500; letter-spacing: 1px; transition: color 0.3s;">
                    LOGOUT
                </a>
            </div>
            
            <div class="upload-wrapper">
                <input type="file" id="image-upload" accept="image/*">
                <label for="image-upload" class="upload-label">
                    Upload Image
                </label>
                <div id="paste-hint" style="margin-top: 14px; color: var(--color-text-dimmer); font-size: 0.7rem; letter-spacing: 0.5px; opacity: 0.8;">
                    Or press Ctrl+V to paste image
                </div>
                
                <!-- Undo/Redo Controls -->
                <div class="undo-redo-controls" style="display: flex; gap: 8px; margin-top: 16px;">
                    <button id="undo-button" class="style-button" style="flex: 1; padding: 8px 12px; font-size: 0.75rem;" disabled title="Undo last action (Ctrl+Z)">
                        â†¶ Undo
                    </button>
                    <button id="redo-button" class="style-button" style="flex: 1; padding: 8px 12px; font-size: 0.75rem;" disabled title="Redo last action (Ctrl+Y)">
                        â†· Redo
                    </button>
                </div>
                
                <button id="reset-button">Reset All Adjustments</button>
            </div>

            <!-- Basic Adjustments -->
            <div class="control-section" data-section-id="basic-adjustments">
                <div class="section-header">Basic Adjustments <span class="arrow">â–¼</span></div>
                <div class="section-content">
                    
                    <div class="control-group">
                        <button id="auto-adjust-button" class="upload-label" style="width: 100%; margin-bottom: 15px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-hover)); font-weight: 600;">
                            Auto Adjust
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <label for="brightness">Brightness</label>
                        <div class="slider-wrapper">
                            <input type="range" id="brightness" min="0" max="200" value="100" data-unit="%" data-css-var="--image-brightness">
                            <span class="value-display">100%</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="contrast">Contrast</label>
                        <div class="slider-wrapper">
                            <input type="range" id="contrast" min="0" max="200" value="100" data-unit="%" data-css-var="--image-contrast">
                            <span class="value-display">100%</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="saturation">Saturation</label>
                        <div class="slider-wrapper">
                            <input type="range" id="saturation" min="0" max="200" value="100" data-unit="%" data-css-var="--image-saturate">
                            <span class="value-display">100%</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="hue-rotate">Hue Rotate</label>
                        <div class="slider-wrapper">
                            <input type="range" id="hue-rotate" min="0" max="360" value="0" data-unit="deg" data-css-var="--image-hue-rotate">
                            <span class="value-display">0deg</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="opacity">Opacity</label>
                        <div class="slider-wrapper">
                            <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" data-unit="" data-css-var="--image-opacity">
                            <span class="value-display">1</span>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Color Effects -->
            <div class="control-section" data-section-id="color-effects">
                <div class="section-header">Color Effects <span class="arrow">â–¼</span></div>
                <div class="section-content">
                    
                    <!-- Quick Enhancement Buttons for Sharpening -->
                    <div class="control-group">
                        <label>Quick Enhancements</label>
                        <div class="button-group" id="quick-enhance-buttons">
                            <!-- This button mimics sharpening by boosting contrast and saturation -->
                            <button class="style-button" data-enhance="sharpen">Sharpen / Detail</button>
                            <button class="style-button" data-enhance="vibrant">Vibrant Pop</button>
                            <button class="style-button" data-enhance="clarity" title="Click for quick clarity, double-click for advanced clarity">Clarity</button>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--color-text-dimmer); margin-top: 8px; opacity: 0.8;">
                            ðŸ’¡ Tip: Double-click Clarity for advanced server-side processing
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="grayscale">Grayscale</label>
                        <div class="slider-wrapper">
                            <input type="range" id="grayscale" min="0" max="100" value="0" data-unit="%" data-css-var="--image-grayscale">
                            <span class="value-display">0%</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="sepia">Sepia</label>
                        <div class="slider-wrapper">
                            <input type="range" id="sepia" min="0" max="100" value="0" data-unit="%" data-css-var="--image-sepia">
                            <span class="value-display">0%</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="invert">Invert</label>
                        <div class="slider-wrapper">
                            <input type="range" id="invert" min="0" max="100" value="0" data-unit="%" data-css-var="--image-invert">
                            <span class="value-display">0%</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="blur">Blur (Set to 0px to Deblur)</label>
                        <div class="slider-wrapper">
                            <input type="range" id="blur" min="0" max="10" value="0" data-unit="px" data-css-var="--image-blur">
                            <span class="value-display">0px</span>
                        </div>
                    </div>
                </div>
            </div>



            <!-- AI Enhancement -->
            <div class="control-section" data-section-id="ai-enhancement">
                <div class="section-header">AI Enhancement <span class="arrow">â–¼</span></div>
                <div class="section-content">
                    
                    <div class="control-group">
                        <label>Enhancement Preset</label>
                        <div class="button-group" id="preset-buttons">
                            <button class="style-button active" data-preset="general">General</button>
                            <button class="style-button" data-preset="portrait">Portrait</button>
                            <button class="style-button" data-preset="landscape">Landscape</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Upscale Factor</label>
                        <div class="button-group" id="scale-buttons">
                            <button class="style-button active" data-scale="1">1x (No Scale)</button>
                            <button class="style-button" data-scale="2">2x</button>
                            <button class="style-button" data-scale="4">4x</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="enhancement-strength">Enhancement Strength</label>
                        <div class="slider-wrapper">
                            <input type="range" id="enhancement-strength" min="0" max="100" value="80" data-unit="%">
                            <span class="value-display">80%</span>
                        </div>
                    </div>

                    <div class="control-group" style="border-bottom: none;">
                        <button id="auto-enhance-button" class="upload-label" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-hover)); font-weight: 600;">
                            Auto Enhance
                        </button>
                        <button id="ai-enhance-button" class="upload-label" style="width: 100%; margin-bottom: 10px;">
                            AI Enhance (Manual)
                        </button>
                        <div id="enhancement-status" style="display: none; text-align: center; color: var(--color-accent); font-size: 0.9rem; margin-top: 10px;">
                            <div class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid var(--color-accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span id="status-text" style="margin-left: 8px;">Processing...</span>
                        </div>
                        <div id="enhancement-error" style="display: none; text-align: center; color: #e53935; font-size: 0.85rem; margin-top: 10px; padding: 8px; background: rgba(229, 57, 53, 0.1); border-radius: 4px;">
                        </div>
                    </div>

                    <div class="control-group" id="enhancement-controls" style="display: none; border-bottom: none;">
                        <button id="compare-button" class="style-button" style="width: 100%; margin-bottom: 8px;">
                            Compare Original
                        </button>
                        <button id="undo-enhancement-button" class="style-button" style="width: 100%; background: #e53935; border-color: #e53935;">
                            Undo Enhancement
                        </button>
                    </div>

                </div>
            </div>

            <!-- Download and Delete Buttons -->
            <div style="padding: 24px 20px; border-top: 1px solid var(--color-border); background-color: var(--color-bg-secondary);">
                <button id="download-button" class="upload-label" style="width: 100%; margin-bottom: 12px;">Download</button>
                <button id="delete-image-button" class="style-button" style="width: 100%; background: #e53935; border-color: #e53935; color: white; padding: 14px 28px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;"> Delete Image</button>
            </div>
            
        </div>

        <div class="editor-area">
            <!-- Preview Controls -->
            <div class="preview-controls" id="preview-controls">
                <span style="font-size: 0.75rem; color: var(--color-text-dim); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Preview Mode:</span>
                <button class="preview-toggle active" id="normal-view">Normal</button>
                <button class="preview-toggle" id="split-view">Before/After</button>
            </div>

            <!-- This container holds the image and applies CSS filters -->
            <div id="image-container">
                <!-- Normal View (default) -->
                <img id="editor-image" alt="Image being edited" 
                    src="https://placehold.co/900x600/0a0a0a/666666?text=Drag+%26+Drop+an+Image+or+Click+to+Upload">
                
                <!-- Split View Container -->
                <div class="split-view-container" id="split-view-container">
                    <img class="split-image original" id="split-original" alt="Original image">
                    <img class="split-image edited" id="split-edited" alt="Edited image">
                    <div class="split-slider" id="split-slider"></div>
                    <div class="split-labels">
                        <span class="split-label original">Original</span>
                        <span class="split-label edited">Edited</span>
                    </div>
                </div>
                
                <!-- Hidden canvas for rendering image with filters before download -->
                <canvas id="render-canvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let originalStyles = {};
        const mainEditorImage = document.getElementById('editor-image');
        const renderCanvas = document.getElementById('render-canvas');
        const inputs = document.querySelectorAll('input[type="range"]'); 
        const quickEnhanceButtons = document.querySelectorAll('#quick-enhance-buttons .style-button');
        
        // Split View Elements
        const previewControls = document.getElementById('preview-controls');
        const normalViewBtn = document.getElementById('normal-view');
        const splitViewBtn = document.getElementById('split-view');
        const splitViewContainer = document.getElementById('split-view-container');
        const splitOriginal = document.getElementById('split-original');
        const splitEdited = document.getElementById('split-edited');
        const splitSlider = document.getElementById('split-slider');
        
        // Split View State
        let splitViewActive = false;
        let originalImageSrc = null;
        let isDragging = false;
        
        // Undo/Redo History Management
        const historyManager = {
            history: [],
            currentIndex: -1,
            maxHistorySize: 50,
            
            // Save current state to history
            saveState: function(action = 'manual') {
                // Remove any future states if we're not at the end
                if (this.currentIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.currentIndex + 1);
                }
                
                // Create state snapshot
                const state = {
                    timestamp: Date.now(),
                    action: action,
                    filters: {},
                    activePresets: []
                };
                
                // Save all filter values
                inputs.forEach(input => {
                    if (input.dataset.cssVar) {
                        state.filters[input.id] = {
                            value: input.value,
                            cssVar: input.dataset.cssVar,
                            unit: input.dataset.unit || ''
                        };
                    }
                });
                
                // Save active preset buttons
                quickEnhanceButtons.forEach(btn => {
                    if (btn.classList.contains('active')) {
                        state.activePresets.push(btn.dataset.enhance);
                    }
                });
                
                // Add to history
                this.history.push(state);
                this.currentIndex++;
                
                // Limit history size
                if (this.history.length > this.maxHistorySize) {
                    this.history.shift();
                    this.currentIndex--;
                }
                
                this.updateButtons();
            },
            
            // Undo last action
            undo: function() {
                if (this.canUndo()) {
                    this.currentIndex--;
                    this.restoreState();
                    this.updateButtons();
                }
            },
            
            // Redo last undone action
            redo: function() {
                if (this.canRedo()) {
                    this.currentIndex++;
                    this.restoreState();
                    this.updateButtons();
                }
            },
            
            // Check if undo is possible
            canUndo: function() {
                return this.currentIndex > 0;
            },
            
            // Check if redo is possible
            canRedo: function() {
                return this.currentIndex < this.history.length - 1;
            },
            
            // Restore state from history
            restoreState: function() {
                if (this.currentIndex >= 0 && this.currentIndex < this.history.length) {
                    const state = this.history[this.currentIndex];
                    
                    // Restore filter values
                    Object.keys(state.filters).forEach(inputId => {
                        const input = document.getElementById(inputId);
                        const filterData = state.filters[inputId];
                        
                        if (input) {
                            input.value = filterData.value;
                            
                            // Update display and CSS
                            const displaySpan = input.closest('.slider-wrapper')?.querySelector('.value-display');
                            if (displaySpan) {
                                displaySpan.textContent = (input.id === 'opacity') ? 
                                    parseFloat(filterData.value).toFixed(2) : 
                                    `${filterData.value}${filterData.unit}`;
                            }
                            
                            // Apply CSS variable
                            document.documentElement.style.setProperty(
                                filterData.cssVar, 
                                `${filterData.value}${filterData.unit}`
                            );
                        }
                    });
                    
                    // Restore active presets
                    quickEnhanceButtons.forEach(btn => btn.classList.remove('active'));
                    state.activePresets.forEach(presetName => {
                        const btn = document.querySelector(`[data-enhance="${presetName}"]`);
                        if (btn) btn.classList.add('active');
                    });
                }
            },
            
            // Update undo/redo button states
            updateButtons: function() {
                const undoBtn = document.getElementById('undo-button');
                const redoBtn = document.getElementById('redo-button');
                
                if (undoBtn) {
                    undoBtn.disabled = !this.canUndo();
                    undoBtn.style.opacity = this.canUndo() ? '1' : '0.5';
                }
                
                if (redoBtn) {
                    redoBtn.disabled = !this.canRedo();
                    redoBtn.style.opacity = this.canRedo() ? '1' : '0.5';
                }
            },
            
            // Clear history (when new image is loaded)
            clearHistory: function() {
                this.history = [];
                this.currentIndex = -1;
                this.updateButtons();
            },
            
            // Initialize with current state
            initialize: function() {
                this.saveState('initial');
            }
        };
        
        // AI Enhancement state
        const enhancementState = {
            isProcessing: false,
            originalImage: null,
            enhancedImage: null,
            currentPreset: 'general',
            currentScale: 1,
            currentStrength: 80,
            compareMode: false
        };
        
        // --- UTILITY FUNCTIONS ---
        
        // Split View Functions
        function toggleSplitView(enable) {
            splitViewActive = enable;
            
            if (enable) {
                // Show split view
                mainEditorImage.style.display = 'none';
                splitViewContainer.classList.add('active');
                normalViewBtn.classList.remove('active');
                splitViewBtn.classList.add('active');
                
                // Update split images
                updateSplitView();
            } else {
                // Show normal view
                mainEditorImage.style.display = 'block';
                splitViewContainer.classList.remove('active');
                normalViewBtn.classList.add('active');
                splitViewBtn.classList.remove('active');
            }
        }
        
        function updateSplitView() {
            if (!splitViewActive || !originalImageSrc) return;
            
            // Set original image (no filters, no AI enhancements)
            splitOriginal.src = originalImageSrc;
            
            // Determine what to show as "edited" version
            if (enhancementState.enhancedImage) {
                // If we have an AI-enhanced image, use it as base and apply CSS filters
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const tempImg = new Image();
                
                tempImg.onload = function() {
                    canvas.width = tempImg.naturalWidth;
                    canvas.height = tempImg.naturalHeight;
                    
                    // Apply current CSS filters to the AI-enhanced image
                    const currentFilter = getComputedStyle(mainEditorImage).filter;
                    const currentOpacity = getComputedStyle(mainEditorImage).opacity;
                    
                    ctx.filter = currentFilter;
                    ctx.globalAlpha = parseFloat(currentOpacity);
                    
                    // Draw the AI-enhanced image with CSS filters applied
                    ctx.drawImage(tempImg, 0, 0);
                    
                    // Set the edited image source (AI + CSS filters combined)
                    splitEdited.src = canvas.toDataURL('image/png');
                };
                
                tempImg.src = enhancementState.enhancedImage;
            } else {
                // No AI enhancement, just apply CSS filters to original
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Wait for original image to load, then create filtered version
                splitOriginal.onload = function() {
                    canvas.width = splitOriginal.naturalWidth;
                    canvas.height = splitOriginal.naturalHeight;
                    
                    // Apply current CSS filters to canvas context
                    const currentFilter = getComputedStyle(mainEditorImage).filter;
                    const currentOpacity = getComputedStyle(mainEditorImage).opacity;
                    
                    ctx.filter = currentFilter;
                    ctx.globalAlpha = parseFloat(currentOpacity);
                    
                    // Draw the filtered image
                    ctx.drawImage(splitOriginal, 0, 0);
                    
                    // Set the edited image source
                    splitEdited.src = canvas.toDataURL('image/png');
                };
            }
        }
        
        function handleSplitSliderDrag(e) {
            if (!isDragging || !splitViewActive) return;
            
            const container = document.getElementById('image-container');
            const rect = container.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
            
            // Update slider position
            splitSlider.style.left = percentage + '%';
            
            // Update clip path for edited image
            splitEdited.style.clipPath = `polygon(${percentage}% 0%, 100% 0%, 100% 100%, ${percentage}% 100%)`;
        }
        
        function showPreviewControls() {
            if (originalImageSrc && !mainEditorImage.src.includes('placehold.co')) {
                previewControls.classList.add('show');
            }
        }
        
        function hidePreviewControls() {
            previewControls.classList.remove('show');
            toggleSplitView(false);
        }
        
        // Helper function to update slider values and CSS based on preset
        function applyFilterPreset(b, c, s, h, gr, sep, inv, bl) {
            const filters = [
                { id: 'brightness', val: b },
                { id: 'contrast', val: c },
                { id: 'saturation', val: s },
                { id: 'hue-rotate', val: h },
                { id: 'grayscale', val: gr },
                { id: 'sepia', val: sep },
                { id: 'invert', val: inv },
                { id: 'blur', val: bl },
                { id: 'opacity', val: 1 } // Always reset opacity to full for presets
            ];

            filters.forEach(filter => {
                const input = document.getElementById(filter.id);
                if (input) {
                    input.value = filter.val;
                    // Trigger the existing update handler to set the CSS variable and display text
                    handleUpdate({ target: input });
                }
            });
        }

        // Caches the initial values of all editable properties on load
        function cacheInitialStyles() {
            inputs.forEach(input => {
                const cssVar = input.dataset.cssVar;
                const value = input.value;
                const unit = input.dataset.unit || '';
                
                // Opacity needs special handling as it uses a factor of 1, not 0.01 like previous versions
                const numericValue = parseFloat(value);
                
                // Store initial value
                originalStyles[cssVar] = {
                    value: value,
                    unit: unit,
                    defaultCSS: `${numericValue}${unit}`
                };
                
                // Apply initial CSS var
                document.documentElement.style.setProperty(cssVar, originalStyles[cssVar].defaultCSS);
            });
        }

        // Debounced history save for slider changes
        let historyTimeout;
        function debouncedHistorySave(action = 'slider_change') {
            clearTimeout(historyTimeout);
            historyTimeout = setTimeout(() => {
                historyManager.saveState(action);
            }, 500); // Save after 500ms of no changes
        }

        // --- HANDLERS ---

        // Handles all slider changes
        function handleUpdate(e) {
            const input = e.target;
            const cssVar = input.dataset.cssVar;
            
            let value = parseFloat(input.value);
            const unit = input.dataset.unit || '';
            
            let displayValue = `${value}${unit}`;

            // Update the value display next to the slider
            const displaySpan = input.closest('.slider-wrapper')?.querySelector('.value-display');
            if (displaySpan) {
                // If opacity, just show the number without %
                displaySpan.textContent = (input.id === 'opacity') ? value.toFixed(2) : displayValue;
            }
            
            // Apply the CSS variable
            document.documentElement.style.setProperty(cssVar, displayValue);

            // Remove active state from enhancement buttons if a manual slider is used
            if(input.closest('#quick-enhance-buttons') === null) {
                quickEnhanceButtons.forEach(btn => btn.classList.remove('active'));
            }
            
            // Update split view if active
            if (splitViewActive) {
                updateSplitView();
            }
            
            // Save to history (debounced)
            debouncedHistorySave('slider_adjustment');
        }
        
        // Handles accordion functionality
        function toggleSection(sectionId) {
            const allSections = document.querySelectorAll('.control-section');
            const targetSection = document.querySelector(`[data-section-id="${sectionId}"]`);
            const targetContent = targetSection.querySelector('.section-content');
            const targetHeader = targetSection.querySelector('.section-header');

            allSections.forEach(section => {
                const content = section.querySelector('.section-content');
                const header = section.querySelector('.section-header');
                
                if (section.dataset.sectionId !== sectionId || !header.classList.contains('active')) {
                    // Close other sections
                    content.classList.remove('open');
                    header.classList.remove('active');
                }
            });
            
            // Toggle the target section
            if (targetHeader.classList.contains('active')) {
                // If it was open, close it
                targetContent.classList.remove('open');
                targetHeader.classList.remove('active');
            } else {
                // If it was closed, open it
                targetContent.classList.add('open');
                targetHeader.classList.add('active');
            }
        }

        // Resets all sliders to default
        function resetAdjustments() {
            // Reset sliders
            inputs.forEach(input => {
                const cssVar = input.dataset.cssVar;
                const defaultProps = originalStyles[cssVar];
                
                if (!defaultProps) return;

                // Reset input value
                input.value = defaultProps.value;

                // Update display and CSS var
                const displaySpan = input.closest('.slider-wrapper')?.querySelector('.value-display');
                if (displaySpan) {
                     // Handle opacity display separately
                    displaySpan.textContent = (input.id === 'opacity') ? parseFloat(defaultProps.value).toFixed(2) : defaultProps.defaultCSS;
                }
                
                document.documentElement.style.setProperty(cssVar, defaultProps.defaultCSS);
            });

            // Reset enhancement buttons
            quickEnhanceButtons.forEach(btn => btn.classList.remove('active'));
            
            // Reset AI enhancement state
            if (enhancementState.originalImage && enhancementState.enhancedImage) {
                // Restore original image if AI enhancement was applied
                mainEditorImage.src = enhancementState.originalImage;
                
                // Clear AI enhancement state
                enhancementState.enhancedImage = null;
                enhancementState.originalImage = null;
                enhancementState.compareMode = false;
                
                // Hide enhancement controls
                const enhancementControls = document.getElementById('enhancement-controls');
                if (enhancementControls) {
                    enhancementControls.style.display = 'none';
                }
                
                // Hide enhancement status messages
                hideEnhancementStatus();
                hideEnhancementError();
            }
            
            // Reset AI preset buttons to default (General)
            const presetButtons = document.querySelectorAll('#preset-buttons .style-button');
            presetButtons.forEach(btn => btn.classList.remove('active'));
            const generalButton = document.querySelector('#preset-buttons .style-button[data-preset="general"]');
            if (generalButton) {
                generalButton.classList.add('active');
                enhancementState.currentPreset = 'general';
            }
            
            // Reset scale and strength to defaults
            enhancementState.currentScale = 1;
            enhancementState.currentStrength = 80;
            
            // Update scale and strength UI elements if they exist
            const scaleButtons = document.querySelectorAll('#scale-buttons .style-button');
            scaleButtons.forEach(btn => btn.classList.remove('active'));
            const scale1Button = document.querySelector('#scale-buttons .style-button[data-scale="1"]');
            if (scale1Button) {
                scale1Button.classList.add('active');
            }
            
            const strengthSlider = document.getElementById('strength');
            if (strengthSlider) {
                strengthSlider.value = 80;
                const strengthDisplay = strengthSlider.closest('.slider-wrapper')?.querySelector('.value-display');
                if (strengthDisplay) {
                    strengthDisplay.textContent = '80%';
                }
            }
            
            // Update split view if active
            if (splitViewActive) {
                updateSplitView();
            }
        }
        
        // Handles file upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageUrl = event.target.result;
                    loadImage(imageUrl);
                };
                reader.readAsDataURL(file);
            }
        }

        // Handles image pasting from clipboard
        function handlePaste(e) {
            console.log('Paste event triggered');
            
            if (!e.clipboardData || !e.clipboardData.items) {
                console.log('No clipboard data available');
                return;
            }
            
            const items = e.clipboardData.items;
            console.log('Clipboard items:', items.length);
            
            for (let i = 0; i < items.length; i++) {
                console.log('Item type:', items[i].type);
                
                if (items[i].type.indexOf("image") !== -1) {
                    console.log('Image found in clipboard');
                    const blob = items[i].getAsFile();
                    
                    if (!blob) {
                        console.log('Failed to get file from clipboard');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        console.log('Image loaded from clipboard');
                        loadImage(event.target.result);
                    };
                    reader.onerror = function(error) {
                        console.error('Error reading clipboard image:', error);
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault(); // Prevent default paste action
                    break;
                }
            }
        }
        
        // Common function to load image into editor
        function loadImage(imageUrl) {
            // Temporarily dim editor while loading
            document.getElementById('image-container').style.opacity = '0.5'; 
            
            // Reset all adjustments upon new image load
            resetAdjustments();
            
            // Clear history for new image
            historyManager.clearHistory();
            
            // Store original image source for split view
            originalImageSrc = imageUrl;

            mainEditorImage.onload = () => {
                document.getElementById('image-container').style.opacity = '1';
                console.log("Image loaded successfully.");
                
                // Show preview controls
                showPreviewControls();
                
                // Update split view if active
                if (splitViewActive) {
                    updateSplitView();
                }
                
                // Initialize history with clean state
                historyManager.initialize();
            };
            
            mainEditorImage.onerror = () => {
                console.error("Error loading image. Check URL or file integrity.");
                document.getElementById('image-container').style.opacity = '1';
                
                // Hide preview controls on error
                hidePreviewControls();
                originalImageSrc = null;
                
                // Fallback to placeholder on error
                mainEditorImage.src = 'https://placehold.co/900x600/FF0000/FFFFFF?text=Image+Load+Failed';
            };
            
            // For cross-origin issues with canvas download, we remove the attribute for local files (like pasted/uploaded).
            // If the URL is external, we would need to check if CORS is enabled, but for local data URLs, it's fine.
            mainEditorImage.removeAttribute('crossOrigin');

            // Set the display image source
            mainEditorImage.src = imageUrl;
        }
        
        // Handles Quick Enhancement button clicks
        function handleQuickEnhance(e) {
            const button = e.target;
            const type = button.dataset.enhance;

            // Remove active state from all buttons in the group
            quickEnhanceButtons.forEach(btn => btn.classList.remove('active'));
            
            // Toggle logic
            if (button.classList.contains('active')) {
                // If it was active, deselect and reset filters
                button.classList.remove('active');
                resetAdjustments(); // Safer to reset all when toggling off
                historyManager.saveState('preset_removed');
                return;
            }

            // Apply new preset
            button.classList.add('active');

            if (type === 'sharpen') {
                // Sharpen preset: High Contrast and Saturation boost mimics sharpness
                applyFilterPreset(105, 125, 125, 0, 0, 0, 0, 0); // B, C, S, H, Gr, Sep, Inv, Blur
            } else if (type === 'vibrant') {
                // Vibrant preset: Slight boost to Brightness, Saturation, and a touch of Contrast
                applyFilterPreset(110, 105, 150, 0, 0, 0, 0, 0); // B, C, S, H, Gr, Sep, Inv, Blur
            } else if (type === 'clarity') {
                // Clarity preset: Enhanced contrast and slight brightness boost for crisp look
                applyFilterPreset(108, 130, 115, 0, 0, 0, 0, 0); // B, C, S, H, Gr, Sep, Inv, Blur
            }
            
            // Save to history after applying preset
            historyManager.saveState(`preset_${type}`);
        }

        // Advanced clarity enhancement using server-side processing
        async function handleAdvancedClarity() {
            if (enhancementState.isProcessing) return;
            
            // Check if image is loaded
            if (!mainEditorImage.src || mainEditorImage.src.includes('placehold.co')) {
                showEnhancementError('Please upload or paste an image first!');
                return;
            }
            
            enhancementState.isProcessing = true;
            const clarityButton = document.querySelector('[data-enhance="clarity"]');
            clarityButton.disabled = true;
            clarityButton.style.opacity = '0.5';
            
            hideEnhancementError();
            showEnhancementStatus('Applying advanced clarity...');
            
            // Store original image if not already stored
            if (!enhancementState.originalImage) {
                enhancementState.originalImage = mainEditorImage.src;
            }
            
            try {
                // Get current image as base64
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = mainEditorImage.naturalWidth;
                canvas.height = mainEditorImage.naturalHeight;
                ctx.drawImage(mainEditorImage, 0, 0);
                const imageData = canvas.toDataURL('image/png');
                
                // Call clarity API
                const response = await fetch('/clarity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData,
                        strength: 85  // High clarity strength
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Clarity enhancement failed');
                }
                
                // Update image with clarity-enhanced version
                const enhancedImageData = 'data:image/jpeg;base64,' + result.enhanced_image_base64;
                enhancementState.enhancedImage = enhancedImageData;
                mainEditorImage.src = enhancedImageData;
                
                // Update split view if active
                if (splitViewActive) {
                    updateSplitView();
                }
                
                // Save to history after AI enhancement
                historyManager.saveState('ai_clarity_enhancement');
                
                // Show success message
                const processingTime = result.metadata.processing_time;
                showEnhancementStatus(`âœ“ Clarity enhanced in ${processingTime}s`);
                setTimeout(hideEnhancementStatus, 3000);
                
                // Show compare and undo buttons
                document.getElementById('enhancement-controls').style.display = 'block';
                
                console.log('Clarity enhancement metadata:', result.metadata);
                
            } catch (error) {
                showEnhancementError(`Clarity enhancement failed: ${error.message}`);
                // Fallback to CSS-only clarity
                applyFilterPreset(108, 130, 115, 0, 0, 0, 0, 0);
            } finally {
                enhancementState.isProcessing = false;
                clarityButton.disabled = false;
                clarityButton.style.opacity = '1';
            }
        }

        // Handles image download by drawing the filtered image onto a canvas
        function downloadImage() {
            if (!mainEditorImage.src || mainEditorImage.src.includes('placehold.co')) {
                 // Use a custom alert message substitute
                 const container = document.getElementById('image-container');
                 const msg = document.createElement('div');
                 msg.textContent = 'Please upload or paste an image first!';
                 msg.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #e53935; color: white; padding: 15px; border-radius: 8px; z-index: 100; font-weight: bold; animation: fadeout 3s forwards;';
                 
                 // Add a simple CSS animation for the message fade
                 const style = document.createElement('style');
                 style.textContent = '@keyframes fadeout { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }';
                 document.head.appendChild(style);
                 
                 container.appendChild(msg);
                 setTimeout(() => { msg.remove(); }, 3000);
                 return;
            }

            // 1. Set canvas size to the natural image dimensions
            renderCanvas.width = mainEditorImage.naturalWidth;
            renderCanvas.height = mainEditorImage.naturalHeight;
            const ctx = renderCanvas.getContext('2d');
            
            // 2. Clear canvas
            ctx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);
            
            // 3. Apply the current CSS filters to the canvas context
            const currentFilter = getComputedStyle(mainEditorImage).filter;
            const currentOpacity = getComputedStyle(mainEditorImage).opacity;
            
            ctx.filter = currentFilter;
            ctx.globalAlpha = parseFloat(currentOpacity);

            // 4. Draw the original image onto the canvas with filters applied
            ctx.drawImage(mainEditorImage, 0, 0, renderCanvas.width, renderCanvas.height);

            // 5. Create a download link
            const link = document.createElement('a');
            link.download = 'PhotoJS_Edited_Image.png';
            link.href = renderCanvas.toDataURL('image/png');
            link.click();
        }
        // Handles image deletion/clearing
        function clearImage() {
            // Reset to placeholder image
            mainEditorImage.src = 'https://placehold.co/900x600/0a0a0a/666666?text=Drag+%26+Drop+an+Image+or+Click+to+Upload';
            
            // Clear original image source
            originalImageSrc = null;
            
            // Reset all adjustments
            resetAdjustments();
            
            // Clear history
            historyManager.clearHistory();
            
            // Hide preview controls
            hidePreviewControls();
            
            // Clear AI enhancement state
            enhancementState.originalImage = null;
            enhancementState.enhancedImage = null;
            enhancementState.compareMode = false;
            
            // Hide enhancement controls
            const enhancementControls = document.getElementById('enhancement-controls');
            if (enhancementControls) {
                enhancementControls.style.display = 'none';
            }
            
            // Hide status messages
            hideEnhancementStatus();
            hideEnhancementError();
            
            // Show confirmation message
            const container = document.getElementById('image-container');
            const msg = document.createElement('div');
            msg.textContent = ' Image deleted successfully';
            msg.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-accent); color: var(--color-bg-primary); padding: 15px 25px; border-radius: 8px; z-index: 100; font-weight: bold; animation: fadeout 2s forwards;';
            
            container.appendChild(msg);
            setTimeout(() => { msg.remove(); }, 2000);
        }


        // --- AI ENHANCEMENT FUNCTIONS ---
        
        async function enhanceImage(imageData, preset, scale, strength) {
            try {
                const response = await fetch('/enhance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData,
                        preset: preset,
                        scale: scale,
                        strength: strength
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Enhancement failed');
                }
                
                return result;
            } catch (error) {
                console.error('Enhancement API error:', error);
                throw error;
            }
        }
        
        function showEnhancementStatus(message) {
            const statusDiv = document.getElementById('enhancement-status');
            const statusText = document.getElementById('status-text');
            statusText.textContent = message;
            statusDiv.style.display = 'block';
            document.getElementById('enhancement-error').style.display = 'none';
        }
        
        function hideEnhancementStatus() {
            document.getElementById('enhancement-status').style.display = 'none';
        }
        
        function showEnhancementError(message) {
            const errorDiv = document.getElementById('enhancement-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            hideEnhancementStatus();
        }
        
        function hideEnhancementError() {
            document.getElementById('enhancement-error').style.display = 'none';
        }
        
        async function handleAIEnhance() {
            if (enhancementState.isProcessing) return;
            
            // Check if image is loaded
            if (!mainEditorImage.src || mainEditorImage.src.includes('placehold.co')) {
                showEnhancementError('Please upload or paste an image first!');
                return;
            }
            
            enhancementState.isProcessing = true;
            const enhanceButton = document.getElementById('ai-enhance-button');
            enhanceButton.disabled = true;
            enhanceButton.style.opacity = '0.5';
            
            hideEnhancementError();
            showEnhancementStatus('Processing...');
            
            // Store original image if not already stored
            if (!enhancementState.originalImage) {
                enhancementState.originalImage = mainEditorImage.src;
            }
            
            try {
                // Get current image as base64
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = mainEditorImage.naturalWidth;
                canvas.height = mainEditorImage.naturalHeight;
                ctx.drawImage(mainEditorImage, 0, 0);
                const imageData = canvas.toDataURL('image/png');
                
                // Show estimated time after 3 seconds
                const timeoutId = setTimeout(() => {
                    showEnhancementStatus('Processing... This may take 10-30 seconds');
                }, 3000);
                
                // Call enhancement API
                const result = await enhanceImage(
                    imageData,
                    enhancementState.currentPreset,
                    enhancementState.currentScale,
                    enhancementState.currentStrength
                );
                
                clearTimeout(timeoutId);
                
                // Update image with enhanced version
                const enhancedImageData = 'data:image/png;base64,' + result.enhanced_image_base64;
                enhancementState.enhancedImage = enhancedImageData;
                mainEditorImage.src = enhancedImageData;
                
                // Update split view if active
                if (splitViewActive) {
                    updateSplitView();
                }
                
                // Save to history after AI enhancement
                historyManager.saveState('ai_manual_enhancement');
                
                // Show success message with processing time
                const processingTime = result.metadata.processing_time;
                showEnhancementStatus(`âœ“ Enhanced in ${processingTime}s`);
                setTimeout(hideEnhancementStatus, 3000);
                
                // Show compare and undo buttons
                document.getElementById('enhancement-controls').style.display = 'block';
                
                console.log('Enhancement metadata:', result.metadata);
                
            } catch (error) {
                showEnhancementError(`Enhancement failed: ${error.message}`);
            } finally {
                enhancementState.isProcessing = false;
                enhanceButton.disabled = false;
                enhanceButton.style.opacity = '1';
            }
        }
        
        function handleCompareToggle() {
            if (!enhancementState.originalImage || !enhancementState.enhancedImage) return;
            
            enhancementState.compareMode = !enhancementState.compareMode;
            const compareButton = document.getElementById('compare-button');
            
            if (enhancementState.compareMode) {
                mainEditorImage.src = enhancementState.originalImage;
                compareButton.textContent = 'Show Enhanced';
                compareButton.classList.add('active');
            } else {
                mainEditorImage.src = enhancementState.enhancedImage;
                compareButton.textContent = 'Compare Original';
                compareButton.classList.remove('active');
            }
            
            // Update split view if active
            if (splitViewActive) {
                updateSplitView();
            }
        }
        
        function handleUndoEnhancement() {
            if (!enhancementState.originalImage) return;
            
            mainEditorImage.src = enhancementState.originalImage;
            enhancementState.enhancedImage = null;
            enhancementState.originalImage = null;
            enhancementState.compareMode = false;
            
            // Update split view if active
            if (splitViewActive) {
                updateSplitView();
            }
            
            document.getElementById('enhancement-controls').style.display = 'none';
            hideEnhancementStatus();
            hideEnhancementError();
        }
        
        // Auto Adjust - Automatically adjusts brightness, contrast, saturation based on image analysis
        function handleAutoAdjust() {
            try {
                // Get current image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = mainEditorImage.naturalWidth;
                canvas.height = mainEditorImage.naturalHeight;
                ctx.drawImage(mainEditorImage, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Analyze image statistics
                let totalBrightness = 0;
                let totalSaturation = 0;
                let pixelCount = 0;
                
                // Sample every 10th pixel for performance
                for (let i = 0; i < data.length; i += 40) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Calculate brightness (perceived luminance)
                    const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
                    totalBrightness += brightness;
                    
                    // Calculate saturation
                    const max = Math.max(r, g, b);
                    const min = Math.min(r, g, b);
                    const saturation = max === 0 ? 0 : (max - min) / max;
                    totalSaturation += saturation;
                    
                    pixelCount++;
                }
                
                const avgBrightness = totalBrightness / pixelCount;
                const avgSaturation = totalSaturation / pixelCount;
                
                // Calculate optimal adjustments (range: 0-200, default: 100)
                let brightnessAdjust = 100;
                let contrastAdjust = 100;
                let saturationAdjust = 100;
                
                // Brightness adjustment (target: 128, range: 0-255)
                if (avgBrightness < 100) {
                    brightnessAdjust = 100 + ((100 - avgBrightness) / 100 * 30);
                } else if (avgBrightness > 160) {
                    brightnessAdjust = 100 - ((avgBrightness - 160) / 95 * 20);
                }
                
                // Contrast adjustment
                if (avgBrightness > 80 && avgBrightness < 180) {
                    contrastAdjust = 115;
                } else {
                    contrastAdjust = 105;
                }
                
                // Saturation adjustment
                if (avgSaturation < 0.25) {
                    saturationAdjust = 100 + ((0.25 - avgSaturation) / 0.25 * 30);
                } else if (avgSaturation > 0.6) {
                    saturationAdjust = 100 - ((avgSaturation - 0.6) / 0.4 * 20);
                }
                
                // Clamp values
                brightnessAdjust = Math.max(0, Math.min(200, Math.round(brightnessAdjust)));
                contrastAdjust = Math.max(0, Math.min(200, Math.round(contrastAdjust)));
                saturationAdjust = Math.max(0, Math.min(200, Math.round(saturationAdjust)));
                
                // Apply adjustments to sliders
                const brightnessSlider = document.getElementById('brightness');
                const contrastSlider = document.getElementById('contrast');
                const saturationSlider = document.getElementById('saturation');
                
                brightnessSlider.value = brightnessAdjust;
                contrastSlider.value = contrastAdjust;
                saturationSlider.value = saturationAdjust;
                
                // Trigger update events
                brightnessSlider.dispatchEvent(new Event('input'));
                contrastSlider.dispatchEvent(new Event('input'));
                saturationSlider.dispatchEvent(new Event('input'));
                
                // Save to history after auto-adjust
                historyManager.saveState('auto_adjust');
                
                showEnhancementStatus('Auto-adjusted based on image analysis');
                setTimeout(hideEnhancementStatus, 2000);
                
            } catch (error) {
                console.error('Auto adjust error:', error);
                showEnhancementError('Auto adjust failed');
            }
        }
        
        // Auto Enhance - Automatically detects image type and applies best enhancement
        async function handleAutoEnhance() {
            if (enhancementState.isProcessing) return;
            
            const autoEnhanceButton = document.getElementById('auto-enhance-button');
            enhancementState.isProcessing = true;
            autoEnhanceButton.disabled = true;
            autoEnhanceButton.style.opacity = '0.5';
            
            hideEnhancementError();
            showEnhancementStatus('Analyzing image...');
            
            if (!enhancementState.originalImage) {
                enhancementState.originalImage = mainEditorImage.src;
            }
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let width = mainEditorImage.naturalWidth;
                let height = mainEditorImage.naturalHeight;
                
                const maxDimension = 3000;
                if (width > maxDimension || height > maxDimension) {
                    const scale = maxDimension / Math.max(width, height);
                    width = Math.floor(width * scale);
                    height = Math.floor(height * scale);
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(mainEditorImage, 0, 0, width, height);
                
                // Analyze image to detect type
                const imageData = ctx.getImageData(0, 0, width, height);
                const detectedPreset = detectImageType(imageData, width, height);
                
                showEnhancementStatus(`Detected ${detectedPreset} image. Enhancing...`);
                
                const base64Data = canvas.toDataURL('image/jpeg', 0.9);
                
                const timeoutId = setTimeout(() => {
                    showEnhancementStatus('Processing... This may take 10-30 seconds');
                }, 3000);
                
                const result = await enhanceImage(base64Data, detectedPreset, 1, 85);
                
                clearTimeout(timeoutId);
                
                const enhancedImageData = 'data:image/jpeg;base64,' + result.enhanced_image_base64;
                enhancementState.enhancedImage = enhancedImageData;
                mainEditorImage.src = enhancedImageData;
                
                // Update split view if active
                if (splitViewActive) {
                    updateSplitView();
                }
                
                // Save to history after auto enhancement
                historyManager.saveState(`auto_enhance_${detectedPreset}`);
                
                const processingTime = result.metadata.processing_time;
                showEnhancementStatus(`Auto-enhanced (${detectedPreset}) in ${processingTime}s`);
                setTimeout(hideEnhancementStatus, 3000);
                
                document.getElementById('enhancement-controls').style.display = 'block';
                
            } catch (error) {
                showEnhancementError(`Auto enhance failed: ${error.message}`);
            } finally {
                enhancementState.isProcessing = false;
                autoEnhanceButton.disabled = false;
                autoEnhanceButton.style.opacity = '1';
            }
        }
        
        // Detect image type based on content analysis
        function detectImageType(imageData, width, height) {
            const data = imageData.data;
            let skinTonePixels = 0;
            let totalPixels = width * height;
            let greenPixels = 0;
            let bluePixels = 0;
            
            for (let i = 0; i < data.length; i += 40) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Detect skin tones (portraits)
                if (r > 95 && g > 40 && b > 20 && r > g && r > b && Math.abs(r - g) > 15) {
                    skinTonePixels++;
                }
                
                // Detect greenery (landscapes)
                if (g > r && g > b && g > 60) {
                    greenPixels++;
                }
                
                // Detect sky/water (landscapes)
                if (b > r && b > g && b > 80) {
                    bluePixels++;
                }
            }
            
            const sampledPixels = totalPixels / 10;
            const skinToneRatio = skinTonePixels / sampledPixels;
            const greenRatio = greenPixels / sampledPixels;
            const blueRatio = bluePixels / sampledPixels;
            
            if (skinToneRatio > 0.15) {
                return 'portrait';
            } else if (greenRatio > 0.25 || blueRatio > 0.25) {
                return 'landscape';
            } else {
                return 'general';
            }
        }



        // --- EVENT LISTENERS & INITIALIZATION ---

        function init() {
            // Cache styles before any interaction
            cacheInitialStyles();
            
            // Attach listeners to all sliders
            inputs.forEach(input => {
                input.addEventListener('input', handleUpdate);
                input.addEventListener('change', handleUpdate); 
            });

            // Attach listeners for accordion headers
            document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sectionId = header.parentElement.dataset.sectionId;
                    toggleSection(sectionId);
                });
            });
            
            // Attach listener for quick enhancement buttons
            quickEnhanceButtons.forEach(btn => {
                btn.addEventListener('click', handleQuickEnhance);
                
                // Add double-click listener for clarity button
                if (btn.dataset.enhance === 'clarity') {
                    btn.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        handleAdvancedClarity();
                    });
                }
            });

            // File and Reset listeners
            document.getElementById('image-upload').addEventListener('change', handleImageUpload);
            document.getElementById('download-button').addEventListener('click', downloadImage);
            document.getElementById('delete-image-button').addEventListener('click', clearImage);
            document.getElementById('reset-button').addEventListener('click', () => {
                resetAdjustments();
                historyManager.saveState('reset_all');
                
                // Update split view if active
                if (splitViewActive) {
                    updateSplitView();
                }
            });
            
            // Undo/Redo listeners
            document.getElementById('undo-button').addEventListener('click', () => {
                historyManager.undo();
                
                // Update split view if active
                if (splitViewActive) {
                    updateSplitView();
                }
            });
            
            document.getElementById('redo-button').addEventListener('click', () => {
                historyManager.redo();
                
                // Update split view if active
                if (splitViewActive) {
                    updateSplitView();
                }
            });
            
            // Keyboard shortcuts for undo/redo
            document.addEventListener('keydown', (e) => {
                // Ctrl+Z for undo
                if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    historyManager.undo();
                    
                    // Update split view if active
                    if (splitViewActive) {
                        updateSplitView();
                    }
                }
                // Ctrl+Y or Ctrl+Shift+Z for redo
                if (e.ctrlKey && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    e.preventDefault();
                    historyManager.redo();
                    
                    // Update split view if active
                    if (splitViewActive) {
                        updateSplitView();
                    }
                }
            });
            
            // Paste listener for the entire document
            document.addEventListener('paste', handlePaste);
            
            // Add focus listener to show paste is ready
            document.addEventListener('focus', () => {
                console.log('Document has focus - paste should work');
            }, true);
            
            // Split View Event Listeners
            normalViewBtn.addEventListener('click', () => {
                toggleSplitView(false);
            });
            
            splitViewBtn.addEventListener('click', () => {
                toggleSplitView(true);
            });
            
            // Split slider drag functionality
            splitSlider.addEventListener('mousedown', (e) => {
                isDragging = true;
                e.preventDefault();
            });
            
            splitSlider.addEventListener('touchstart', (e) => {
                isDragging = true;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', handleSplitSliderDrag);
            document.addEventListener('touchmove', handleSplitSliderDrag);
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            document.addEventListener('touchend', () => {
                isDragging = false;
            });
            
            // AI Enhancement listeners
            const presetButtons = document.querySelectorAll('#preset-buttons .style-button');
            presetButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    presetButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    enhancementState.currentPreset = btn.dataset.preset;
                });
            });
            
            const scaleButtons = document.querySelectorAll('#scale-buttons .style-button');
            scaleButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    scaleButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    enhancementState.currentScale = parseInt(btn.dataset.scale);
                });
            });
            
            const strengthSlider = document.getElementById('enhancement-strength');
            strengthSlider.addEventListener('input', (e) => {
                enhancementState.currentStrength = parseInt(e.target.value);
                e.target.nextElementSibling.textContent = e.target.value + '%';
            });
            
            document.getElementById('auto-adjust-button').addEventListener('click', handleAutoAdjust);
            document.getElementById('auto-enhance-button').addEventListener('click', handleAutoEnhance);
            document.getElementById('ai-enhance-button').addEventListener('click', handleAIEnhance);
            document.getElementById('compare-button').addEventListener('click', handleCompareToggle);
            document.getElementById('undo-enhancement-button').addEventListener('click', handleUndoEnhancement);
            
            // Initial setup to ensure the UI starts with the first section expanded
            toggleSection('basic-adjustments');
            
            // Initialize history manager
            historyManager.initialize();
        }

        window.onload = init;

    </script>
</body>
</html>

